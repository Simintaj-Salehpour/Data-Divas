---
title: "Mid-Term Summary Paper: Examining the Relationship Between Demographics, Admission Types, and Clinical Outcomes in New York Inpatients (Niagara County)"
author: "Team 2: Simintaj Salehpour, Madeline Bumpus, Nazish Atta, Divya Mistry"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    theme: flatly          # modern, clean blue theme
    highlight: tango       # gentle code highlight colors
    toc: true              # show table of contents
    toc_float: true        # floating TOC on the right
    number_sections: true  # adds section numbers
    df_print: paged        # pretty tables
    code_folding: hide     # hides code by default
    smooth_scroll: true    # smooth navigation
    self_contained: true   # all assets embedded
---
<style>
body {
  background-color: #f4f8fb; /* light blue-gray */
  color: #222;
  font-family: "Lato", "Helvetica Neue", sans-serif;
}
h1, h2, h3 {
  color: #004d80;
}
</style>
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(knitr)
library(kableExtra)
library(skimr)
library(naniar)
library(dplyr)
library(ezids)
theme_set(theme_minimal())
```

# Introduction

Our team chose to examine differences in **hospital length of stay (LOS)** across **insurance types** because it highlights an important intersection between healthcare access, cost, and patient outcomes. The relationship between insurance coverage and hospital utilization is central to understanding disparities in care delivery and efficiency within the U.S. healthcare system. 
We were particularly interested in comparing **Medicare**, which primarily serves older adults, and **Private Insurance**, which often provides broader access to care, to see how coverage type influences hospital resource use. Members of our team who have personally dealt with **Medicaid** and have seen firsthand how insurance status can impact the quality, timing, and length of medical care also find personal significance in this topic. We sought to better understand how insurance differences translate into quantifiable healthcare outcomes by combining our personal viewpoints with data-driven evidence through the analysis of actual hospital discharge data.


# Data Description

## Datasets used

This analysis uses data from the **New York State Department of Health (NYSDOH) Statewide Planning and Research Cooperative System (SPARCS)**, specifically the *Hospital Inpatient Discharges (SPARCS De-Identified)* dataset for **Niagara County, 2012**.
The dataset includes detailed records of all hospital discharges statewide, with variables describing patient demographics, diagnoses, procedures, hospital facility characteristics, insurance/payment type, admission type, and clinical outcomes. Each row represents one patient discharge, allowing for analysis of trends in hospital length of stay, cost, and patient mix.
The full dataset contains over **2 million records** across New York State; for this project, a subset of approximately **21,000 discharges from Niagara County** was used to maintain manageability and statistical power. This dataset is publicly available through the **NY Open Data Portal** and is widely used in healthcare policy, public health, and data science research.


## Limitations


While comprehensive, the SPARCS dataset has several limitations:

- **Socioeconomic data**: Includes insurance type but lacks indicators such as income or education.  
- **Clinical detail**: Limited measures of illness severity or comorbidities.  
- **Temporal relevance**: Data from 2012; may not reflect post–Affordable Care Act effects.  
- **Post-discharge outcomes**: No readmissions or long-term outcomes.  
- **Behavioral factors**: Missing data on lifestyle and health behaviors.  

Additional data on patient severity, comorbidities, or post-discharge outcomes would allow for more nuanced analyses and better control for confounding factors.

## Variable glossary (required for reproducibility)

Our team chose to examine differences in hospital length of stay across insurance types because it highlights an important intersection between healthcare access, cost, and patient outcomes.The relationship between insurance coverage and hospital utilization is central to understanding disparities in care delivery and efficiency within the U.S. healthcare system. We were particularly interested in comparing Medicare, which primarily serves older adults, and Private Insurance, which often provides broader access to care, to see how coverage type influences hospital resource use. Members of our team who have personally dealt with Medicaid and have seen firsthand how insurance status can impact the quality, timing, and length of medical care also find personal significance in this topic. We sought to better understand how insurance differences translate into quantifiable healthcare outcomes by combining our personal viewpoints with data-driven evidence through the analysis of actual hospital discharge data.


| **Field Name** | **Type** | **Description** |
|----------------|-----------|-----------------|
| hospital_service_area | Text | — |
| hospital_county | Text | — |
| operating_certificate_number | Text | — |
| facility_id | Number | — |
| facility_name | Text | — |
| age_group | Text | — |
| zip_code_3_digits | Text | 3-digit ZIP code. |
| gender | Text | (M) Male, (F) Female, (U) Unknown. |
| race | Text | Black/African American, Multi, Other Race, Unknown, White. “Other” includes Native Americans and Asian/Pacific Islanders. |
| ethnicity | Text | Spanish/Hispanic Origin, Not of Spanish/Hispanic Origin, Multi, Unknown. |
| length_of_stay | Text | (Discharge − Admission) + 1; LOS ≥120 coded as 120+. |
| type_of_admission | Text | Elective, Emergency, Newborn, Not Available, Trauma, Urgent. |
| patient_disposition | Text | Discharge destination/status. |
| discharge_year | Text | Year (CCYY) of discharge. |
| ccs_diagnosis_code | Text | AHRQ CCS Diagnosis Code. |
| ccs_diagnosis_description | Text | AHRQ CCS Diagnosis Description. |
| ccs_procedure_code | Text | AHRQ CCS Procedure Code. |
| ccs_procedure_description | Text | AHRQ CCS Procedure Description. |
| apr_drg_code | Text | APR-DRG Code. |
| apr_drg_description | Text | APR-DRG Description (v28). |
| apr_mdc_code | Text | APR Major Diagnostic Category (MDC) Code. |
| apr_mdc_description | Text | APR Major Diagnostic Category Description. |
| apr_severity_of_illness_code | Text | 1–4 (Minor to Extreme). |
| apr_severity_of_illness_description | Text | Minor(1), Moderate(2), Major(3), Extreme(4). |
| apr_risk_of_mortality | Text | 1–4 (Minor to Extreme). |
| apr_medical_surgical_description | Text | Medical, Surgical, or Not Applicable. |
| source_of_payment_1 | Text | Primary payment type. |
| source_of_payment_2 | Text | Secondary payment type. |
| source_of_payment_3 | Text | Tertiary payment type. |
| birth_weight | Text | Neonate weight (grams, rounded to 100g). |

```{r Load Dataset, include=T, results='markup'}
# Load CSV file
data <- read.csv("Hospital_Inpatient_Discharges.csv")

#Clean column names to avoid backticks

names(data) <- make.names(names(data))

cat("Dataset dimensions: Rows:", nrow(data), "Columns:", ncol(data), "\n")
#glimpse(data)

```


# Exploratory Data Analysis (EDA) (Overview of Analytical Framework)

To evaluate the SMART questions, we used a **quantitative, inferential statistics** approach. The SPARCS 2012 Niagara County subset contained **21,075 records × 34 variables**.

- Check missing data
- Remove duplicate rows

## Missing data
- Report missingness by variable:
We check if there is a missing value or not. For each column check the missing value.

```{r Missing Value, include=T, results = "markup"}

# --- 1. Summary of missing values ---
missing_summary <- data %>% summarise(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "column(variable)", values_to = "n_missing") %>% arrange(desc(n_missing))

#missing_summary

# --- 2. Visualize missingness per column ---
gg_miss_var(data) + labs(title = "Variables VS Number of Missing Values") +
  theme( plot.title = element_text(face = "bold", color = "darkblue"))

# --- 3. Check if there are any missing values ---
clean_data <- data
if(any(is.na(data))) {
  
  cat("Missing values detected!\n")
  total_missing <- sum(is.na(data))
  total_cells <- nrow(data) * ncol(data)
  
  # Remove rows if missing values are few (<5% of total data)
  if(total_missing / total_cells < 0.05) {
    clean_data <- na.omit(data)
    cat("Rows with missing values removed.\n")
  } 
  else {
    # Impute numeric columns with median
    for(col in names(clean_data)) {
      if(is.numeric(clean_data[[col]])) {          # Check if the column is numeric
          clean_data[[col]][is.na(clean_data[[col]])] <- median(clean_data[[col]], na.rm = TRUE)  
      }
    }
    cat("Missing values in numeric columns replaced with median.\n")
  }
  
} else {
  cat("No missing values detected. Dataset is clean.\n")
}


```


## Remove Duplicates
- Report Duplicates by row:
 Check to remove duplicates:
```{r Remove Duplicates, include=T, results = "markup"}
dup_count <- sum(duplicated(clean_data))
cat("Number of duplicate rows:", dup_count, "\n")

# Remove duplicates
clean_data <- clean_data %>% distinct()
```
# SMART Questions

The team developed the following **SMART research questions** based on data availability, clinical reasoning, and literature review. These focus on measurable outcomes—length of stay and costs—to analyze healthcare disparities.


1. **Did Medicare patients have, on average, longer hospital stays than Private Insurance patients in 2012?**
- Rationale: Medicare serves older adults with more complex needs.
2. **Were Medicaid patients’ total hospital costs higher than those with Private Insurance in 2012?**
- Rationale: Medicaid patients may face barriers to preventive care.
3. **Did elderly patients (70+) stay longer than patients aged 30–49 in 2012?**
- Rationale: Older adults typically require longer stays due to frailty and chronic conditions.
4. **Did emergency admissions result in longer hospital stays than elective ones in 2012?**
- Rationale: Emergency cases often involve acute conditions requiring intensive care.


**EDA findings refined our research questions and analytical methods.**  
We determined that including specific percentages in the SMART questions was unnecessary, so we removed them for clarity and flexibility. The EDA also revealed **skewed distributions and outliers**, prompting us to apply **log-transformations**, **robust models**, and **winsorized charges** to ensure more reliable results. Overall, our workflow now follows a clear and systematic sequence: **data cleaning → EDA → statistical testing and adjusted modeling → interpretation**, all supported by consistent visualizations and transparent variable documentation.
# Statistical Tests and Modeling

## SMART Question 1  
**Did Medicare patients have, on average, longer hospital stays than Private Insurance patients in Niagara County (2012)?**

```{r Q1, message = FALSE, warning = FALSE, include=FALSE}




# -----------------------------------------------------------
cat("Step 3: Categorizing insurance types and converting stay length to numeric\n")
df <- data %>%
  mutate(
    Insurance_Group = case_when(
      Payment.Typology.1 == "Medicare" |
        Payment.Typology.2 == "Medicare" |
        Payment.Typology.3 == "Medicare" ~ "Medicare",
      Payment.Typology.1 %in% c("Blue Cross/Blue Shield", "Private Health Insurance") |
        Payment.Typology.2 %in% c("Blue Cross/Blue Shield", "Private Health Insurance") |
        Payment.Typology.3 %in% c("Blue Cross/Blue Shield", "Private Health Insurance") ~ "Private Insurance",
      TRUE ~ NA_character_
    ),
    Length.of.Stay = as.numeric(Length.of.Stay)
  ) %>%
  filter(!is.na(Insurance_Group), !is.na(Length.of.Stay)) %>%
  group_by(Insurance_Group) %>%
  filter(between(
    Length.of.Stay,
    quantile(Length.of.Stay, 0.25, na.rm = TRUE) - 1.5 * IQR(Length.of.Stay, na.rm = TRUE),
    quantile(Length.of.Stay, 0.75, na.rm = TRUE) + 1.5 * IQR(Length.of.Stay, na.rm = TRUE)
  )) %>%
  ungroup()

cat("Insurance groups categorized and outliers removed.\n\n")

# -----------------------------------------------------------
cat("Step 4: Computing descriptive statistics\n")
group_stats <- df %>%
  group_by(Insurance_Group) %>%
  summarise(
    mean_LOS = mean(Length.of.Stay, na.rm = TRUE),
    sd_LOS = sd(Length.of.Stay, na.rm = TRUE),
    count = n()
  )
print(group_stats)
cat("\nDescriptive statistics calculated for each insurance group.\n\n")

# -----------------------------------------------------------
#cat("Step 5: Computing ratio of means (Medicare vs. Private)\n")
ratio <- group_stats$mean_LOS[group_stats$Insurance_Group == "Medicare"] /
  group_stats$mean_LOS[group_stats$Insurance_Group == "Private Insurance"]
cat("Mean Medicare LOS is", round(ratio, 2), "times that of Private Insurance.\n\n")

# -----------------------------------------------------------
#cat("Step 6: Running one-sided t-test\n")
t_result <- t.test(
  Length.of.Stay ~ Insurance_Group,
  data = df,
  alternative = "greater",
  na.action = na.omit
)
print(t_result)
#cat("T-test completed.\n\n")

```

```{r Q1-result, message=FALSE, warning=FALSE}


# -----------------------------------------------------------
#cat("Step 7: Interpreting results\n")
p_val <- t_result$p.value
medicare_mean <- group_stats$mean_LOS[group_stats$Insurance_Group == "Medicare"]
private_mean <- group_stats$mean_LOS[group_stats$Insurance_Group == "Private Insurance"]
diff_ratio <- (medicare_mean / private_mean)
percent_diff <- (diff_ratio - 1) * 100

if (!is.na(p_val) && !is.na(diff_ratio)) {
  if (p_val < 0.05 & diff_ratio >= 1.15) {
    cat("Medicare patients stayed significantly longer on average.\n",
        "The mean length of stay for Medicare patients (", round(medicare_mean, 2),
        " days) was about ", round(percent_diff, 1),
        "% longer than for Private Insurance patients (", round(private_mean, 2),
        " days), with p = ", signif(p_val, 4),
        ". This difference is statistically significant (p < 0.05).\n", sep = "")
  } else {
    cat("No statistically significant difference of at least 15% in average hospital stay ",
        "between Medicare and Private Insurance patients (p = ", signif(p_val, 4), ").\n", sep = "")
  }
} 

# -----------------------------------------------------------
#cat("Step 8: Visualizing average hospital stays by insurance type\n")
ggplot(group_stats, aes(x = Insurance_Group, y = mean_LOS, fill = Insurance_Group)) +
  geom_bar(stat = "identity", width = 0.6, color = "black") +
  geom_text(aes(label = round(mean_LOS, 2)), vjust = -0.4, size = 4) +
  labs(
    title = "Average Hospital Length of Stay by Insurance Type (Niagara County, 2012)",
    x = "Insurance Type",
    y = "Mean Length of Stay (Days)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

## SMART Question 2
**Can we analyze 2012 hospital records to quantify whether Medicaid patients’ total hospital costs were higher than patients with Private Insurance? **

```{r Q2, message=FALSE, warning=FALSE, include=FALSE, include=FALSE}

# 1 Select relevant columns
cat("Step 1: Select relevant columns:\n\n")
columns_to_keep <- c("Facility.ID", "Age.Group", "Gender", "Length.of.Stay",
  "Payment.Typology.1", "Payment.Typology.2", "Payment.Typology.3",
  "Total.Charges", "Total.Costs")
cat("Selected columns:",columns_to_keep)

hospital_final <- clean_data[, columns_to_keep]


# 2 Filter Medicaid and Private insurance types
cat(" Step 2:Filter Medicaid and Private insurance type")
insurance_pattern <- "blue cross|blue shield|bcbs|private insurance|medicaid"
hospital_filtered <- hospital_final %>%
  filter(
    str_detect(tolower(Payment.Typology.1), insurance_pattern) |
    str_detect(tolower(Payment.Typology.2), insurance_pattern) |
    str_detect(tolower(Payment.Typology.3), insurance_pattern)
  )
head(hospital_filtered)

# 3 Create insurance group labels
cat("Step3: Create insurance group labels: Grouping insurances to two groups of Medicaid and Private")
values_to = "Insurance.Type"

hospital_filtered <- hospital_filtered %>%
  mutate(
    Insurance_Use = if_else(
      if_any(starts_with("Payment.Typology"), ~ str_detect(str_to_lower(.), "medicaid")),
      "Medicaid", "Private Insurance"
    )
  )
head(hospital_filtered)

# 4 Remove outliers using ezids::outlierKD2()
cat("Step 4: Remove outliers using ezids::outlierKD2()")
cat("Removing outliers for Total.Costs:\n")
hospital_no_outliers <- outlierKD2(hospital_filtered, Total.Costs, rm = TRUE, qqplt = TRUE)

cat("Removing outliers for Total.Charges:\n")
hospital_no_outliers <- outlierKD2(hospital_no_outliers, Total.Charges, rm = TRUE, qqplt = TRUE)

cat("Step 5: Apply statical T-test (Welch Two Sample t-test) ")
# --- Statistical test (t-test) ---
cat("Apply T-test on Average Total Hospital Costs by Insurance Type:")
t_result <- t.test(`Total.Costs` ~ Insurance_Use, data = hospital_no_outliers)
print(t_result)


# --- t-test for Total Charges ---
cat("Apply T-test on Average Total Hospital charge by Insurance Type:")
t_charge_result <- t.test(`Total.Charges` ~ Insurance_Use, data = hospital_no_outliers)
print(t_charge_result)


```

```{r Q2-result, message=FALSE, warning=FALSE}
# --- Bar plot: Mean Total Costs by Insurance Type ---
cost_means <- hospital_no_outliers %>%
  group_by(Insurance_Use) %>%
  summarise(mean_cost = mean(`Total.Costs`, na.rm = TRUE))


ggplot(cost_means, aes(x = Insurance_Use, y = mean_cost, fill = Insurance_Use)) +
  geom_bar(stat = "identity", width = 0.5) +
  geom_text(aes(label = round(mean_cost, 0)), vjust = -0.5, size = 4) +
  labs(
    title = "Average Total Hospital Costs by Insurance Type",
    x = "Insurance Type",
    y = "Mean Total Costs ($)"
  ) +
  scale_fill_manual(values = c("Medicaid" = "#FF9999", "Private Insurance" = "#99CCFF")) +
  theme_minimal() +
  theme(legend.position = "none")  

# Print result

means <- t_result$estimate
different_percent <- (means[1] - means[2]) / means[2] * 100
ci <- t_result$conf.int

if(different_percent>0){
  cat(" Medicaid patients' total hospital costs are approximately", round(abs(different_percent), 2), "% higher than Private Insurance.\n")
}else{
   cat("Medicaid patients' total hospital costs are approximately", round(abs(different_percent), 2), "% lower than Private Insurance.\n")
  cat("Medicaid patients had lower mean total hospital costs ($", round(means[1],2), 
    ") than Private Insurance patients ($", round(means[2],2), "), approximately ", 
    round(abs(different_percent),2), "% difference. ",
    "The difference was statistically significant (t = ", round(t_result$statistic,2),
    ", df = ", round(t_result$parameter,1), ", p < 0.001).\n", sep = "")
}

cat("Extra part: Here we check the total_charge based on insurance types:")

# --- Bar plot: Mean Total Charges by Insurance Type ---
cost_means <- hospital_no_outliers %>%
  group_by(Insurance_Use) %>%
  summarise(mean_cost = mean(`Total.Charges`, na.rm = TRUE))


ggplot(cost_means, aes(x = Insurance_Use, y = mean_cost, fill = Insurance_Use)) +
  geom_bar(stat = "identity", width = 0.5) +
  geom_text(aes(label = round(mean_cost, 0)), vjust = -0.5, size = 4) +
  labs(
    title = "Average Total Hospital Charges by Insurance Type",
    x = "Insurance Type",
    y = "Mean Total Charges ($)"
  ) +
  scale_fill_manual(values = c("Medicaid" = "#FF9999", "Private Insurance" = "#99CCFF")) +
  theme_minimal() +
  theme(legend.position = "none")  

# Print result

means <- t_charge_result$estimate
different_percent <- (means[1] - means[2]) / means[2] * 100
ci <- t_charge_result$conf.int

if(different_percent>0){
  cat(" Medicaid patients' total hospital charges are approximately", round(abs(different_percent), 2), "% higher than Private Insurance.\n")
}else{
   cat("Medicaid patients' total hospital charges are approximately", round(abs(different_percent), 2), "% lower than Private Insurance.\n")
  cat("Medicaid patients had lower mean total hospital charges ($", round(means[1],2), 
    ") than Private Insurance patients ($", round(means[2],2), "), approximately ", 
    round(abs(different_percent),2), "% difference. ",
    "The difference was statistically significant (t = ", round(t_charge_result$statistic,2),
    ", df = ", round(t_charge_result$parameter,1), ", p < 0.001).\n", sep = "")
}
```
## SMART Question 3 
**Did elderly patients (70+) stay longer than patients aged 30–49 in 2012?**

```{r Q3, message=FALSE, warning=FALSE, include=FALSE}
# Use cleaned dataset
data_df <- clean_data
# Inspect columns
#table(data_df$Discharge.Year, useNA="ifany")
cat("Create age buckets")
table(data_df$Age.Group, useNA="ifany")
# Create age buckets

data_df <- data_df %>%
mutate(age_bucket = case_when(
  grepl("70", Age.Group, ignore.case = TRUE) ~ "70+",
  grepl("30", Age.Group, ignore.case = TRUE) & grepl("49", Age.Group, ignore.case = TRUE) ~ "30-49",
  TRUE ~ NA_character_
))
cat("Age buckets created. Here are the counts:\n")
print(table(data_df$age_bucket, useNA="ifany"))
# Clean Length of Stay
data_df$Length.of.Stay <- as.numeric(data_df$Length.of.Stay)
cat("Length.of.Stay cleaned. Sample values:\n")
print(head(data_df$Length.of.Stay, 10))
# Subsets
g70 <- data_df %>% filter(age_bucket == "70+") %>% pull(Length.of.Stay)
g30 <- data_df %>% filter(age_bucket == "30-49") %>% pull(Length.of.Stay)
cat("Number of 70+ patients:", length(g70), "\n")
cat("Number of 30-49 patients:", length(g30), "\n")
# Descriptive stats
summary_stats <- data_df %>%
group_by(age_bucket) %>%
summarise(
n = n(),
mean = mean(Length.of.Stay, na.rm=TRUE),
median = median(Length.of.Stay, na.rm=TRUE),
sd = sd(Length.of.Stay, na.rm=TRUE)
)
summary_stats
cat("Descriptive statistics by age bucket:\n")
print(summary_stats)
#percent difference
mean70 <- mean(g70, na.rm=TRUE)
mean30 <- mean(g30, na.rm=TRUE)
percent_longer <- (mean70 - mean30) / mean30 * 100
cat("\nPercent longer stay for 70+ vs 30–49:", round(percent_longer,2), "%\n")
cat("Count of observations:\n")
cat("70+ group:", sum(!is.na(g70)), "\n")
cat("30-49 group:", sum(!is.na(g30)), "\n")
# Check data availability
n70 <- sum(!is.na(g70))
n30 <- sum(!is.na(g30))

cat("Number of observations:\n")
cat("70+ group:", n70, "\n")
cat("30–49 group:", n30, "\n")

# Run t-test only if both groups have at least 2 valid observations
if (n70 > 1 & n30 > 1) {
  tres <- t.test(g70, g30, var.equal = FALSE)
  print(tres)
} else {
  cat("\n❌ Not enough data for Welch t-test. Skipping this step.\n")
}
# SMART Question 3: Do elderly patients (70+) stay longer than patients aged 30–49?

# 1. Load dataset
df <- clean_data

# 2. Clean and inspect Age.Group
df$Age.Group <- trimws(df$Age.Group)
cat("Unique Age Groups:\n")
print(unique(df$Age.Group))

# 3. Flexible filter for the two target groups
df_age <- df %>%
  filter(
    (grepl("30", Age.Group, ignore.case = TRUE) & grepl("49", Age.Group, ignore.case = TRUE)) |
    grepl("70", Age.Group, ignore.case = TRUE)
  ) %>%
  droplevels()

# 4. Clean Length.of.Stay
df_age$Length.of.Stay <- suppressWarnings(as.numeric(df_age$Length.of.Stay))
df_age <- df_age %>% filter(!is.na(Length.of.Stay))

# 5. Check resulting groups
cat("\nGroups after filtering:\n")
print(table(df_age$Age.Group, useNA="ifany"))

# Proceed only if two groups with valid data

```

```{r Q3-result, message=FALSE, warning=FALSE}
 # Proceed only if two groups with valid data
if (length(unique(df_age$Age.Group)) == 2 &&
    all(sapply(split(df_age$Length.of.Stay, df_age$Age.Group), function(x) length(x) > 1))) {
  
  # Group means
  age_means <- df_age %>%
    group_by(Age.Group) %>%
    summarise(mean_LOS = mean(Length.of.Stay, na.rm = TRUE))
  print(age_means)
  
  # Calculate ratio
  ratio_age <- age_means$mean_LOS[grepl("70", age_means$Age.Group)] /
               age_means$mean_LOS[grepl("30", age_means$Age.Group)]
  cat("\nElderly / 30–49 ratio =", round(ratio_age, 2), "\n")
  
  # One-sided t-test (elderly > younger)
  #cat("\nWelch Two Sample t-test:\n")
  #print(t.test(Length.of.Stay ~ Age.Group, data = df_age, alternative = "greater"))
  
  # Boxplot
  ggplot(df_age, aes(x = Age.Group, y = Length.of.Stay, fill = Age.Group)) +
    geom_boxplot() +
    theme_minimal() +
    labs(title = "Length of Stay by Age Group (Niagara)",
         x = "Age Group", y = "Length of Stay (days)")
  
} else {
  cat("\n❌ Cannot run t-test. Check data integrity.\n")
}


cat("p-value < 0.05\n",
    "Since the p-value is less than 0.05, we reject the null hypothesis.\n",
    "This means there is a statistically significant difference between the two group means.\n",
    "Elderly pationts(70+) stay signigicantly longer in the hospital compared to pationts aged 30-49.\n\n")

```

## SMART Question 4 
**Did emergency admissions result in longer hospital stays than elective ones in 2012?**

```{r Q4, message=FALSE, warning=FALSE, include=FALSE}

#library(tidyverse)
library(janitor)
#library(ggplot2)
library(car)
library(knitr)


# --- Title & Introduction ---------------------------------------------------

cat("
Purpose:
Analyze the difference in Length of Stay (LOS) between Emergency and Elective admissions
using SPARCS 2012 Niagara County data.

Why it matters:
Hospital efficiency and patient-flow optimization rely on understanding LOS variation.
")


# --- Data Preparation -------------------------------------------------------

df <- read_csv("Hospital_Inpatient_Discharges.csv")
dfq <- df %>%
clean_names() %>%
filter(hospital_county == "Niagara") %>%
distinct() %>%
transmute(
los = as.numeric(length_of_stay),
admission_type = factor(type_of_admission),
age_group = factor(age_group),
gender = factor(gender)
) %>%
drop_na(los, admission_type) %>%
  filter(admission_type %in% c("Emergency", "Elective"))

kable(head(dfq))
summary(dfq)



leveneTest(los ~ admission_type, data = dfq)

# --- Welch’s t-test (emergency vs elective only) ----------------------------

dfq_test <- dfq %>%
  filter(admission_type %in% c("Emergency", "Elective")) %>%
  droplevels()

unique(dfq_test$admission_type)

t_res <- t.test(los ~ admission_type, data = dfq_test, var.equal = FALSE)
t_res

#### --- Percent Difference (to test the 30% from question) -------------------

mean_values <- dfq_test %>%
  group_by(admission_type) %>%
  summarise(mean_los = mean(los, na.rm = TRUE), .groups = "drop")

mean_values

mean_emergency <- mean_values$mean_los[mean_values$admission_type == "Emergency"]
mean_elective  <- mean_values$mean_los[mean_values$admission_type == "Elective"]

# Percent difference: (E - L) / L * 100
perc_diff <- (mean_emergency - mean_elective) / mean_elective * 100

# Direction-aware message
if (perc_diff >= 0) {
  cat("Emergency stays are", round(perc_diff, 2), "% LONGER than Elective stays.\n")
} else {
  cat("Emergency stays are", round(abs(perc_diff), 2), "% SHORTER than Elective stays.\n")
}

# --- Ratio check for the '30% longer' hypothesis ----------------------------

ratio_obs <- mean_emergency / mean_elective
cat("Observed mean ratio (Emergency/Elective):", round(ratio_obs, 3), "\n")

if (ratio_obs >= 1.3) {
  message("Emergency stays meet or exceed the 30% longer hypothesis.")
} else {
  message("Emergency stays do NOT meet the 30% longer hypothesis.")
}

# --- Effect Size + Log Sensitivity -----------------------------------------


if ("effectsize" %in% rownames(installed.packages())) {
library(effectsize)
cohens_d(los ~ admission_type, data = dfq_test)
} else {
los_emergency <- dfq_test$los[dfq_test$admission_type == "Emergency"]
los_elective  <- dfq_test$los[dfq_test$admission_type == "Elective"]
mean_diff <- mean(los_emergency) - mean(los_elective)
pooled_sd <- sqrt(((sd(los_emergency)^2 + sd(los_elective)^2) / 2))
cohen_d <- mean_diff / pooled_sd
cat("Manual Cohen’s d =", round(cohen_d, 3), "\n")
}

dfq_test <- dfq_test %>% mutate(log_los = log1p(los))
t.test(log_los ~ admission_type, data = dfq_test)



# --- Regression (Age & Gender) ------------------------------------

lm_los <- lm(los ~ admission_type + age_group + gender, data = dfq)
summary(lm_los)

```

```{r Q4-result, message=FALSE, warning=FALSE}
# --- EDA Visuals ------------------------------------------------------------

# Violin + Box + CI

ggplot(dfq, aes(admission_type, los, fill = admission_type)) +
geom_violin(trim = FALSE, alpha = 0.5) +
geom_boxplot(width = 0.2, alpha = 0.7, color = "black") +
stat_summary(fun.data = mean_cl_normal, geom = "pointrange", color = "red") +
labs(title = "Length of Stay by Admission Type (Niagara County)",
x = "Admission Type", y = "Length of Stay (Days)") +
theme_minimal()


# Histogram

ggplot(dfq, aes(los, fill = admission_type)) +
geom_histogram(position = "identity", alpha = 0.5, bins = 30) +
facet_wrap(~ admission_type, scales = "free_y") +
theme_minimal() +
labs(title = "Distribution of LOS by Admission Type",
x = "Length of Stay", y = "Frequency")
# Mean LOS by Age Group

dfq %>%
group_by(age_group, admission_type) %>%
summarise(mean_los = mean(los, na.rm = TRUE)) %>%
ggplot(aes(age_group, mean_los, fill = admission_type)) +
geom_col(position = "dodge") +
labs(title = "Mean LOS by Age Group and Admission Type",
x = "Age Group", y = "Average LOS (Days)") +
theme_minimal()


# Mean LOS by Gender

dfq %>%
group_by(gender, admission_type) %>%
summarise(mean_los = mean(los, na.rm = TRUE)) %>%
ggplot(aes(gender, mean_los, fill = admission_type)) +
geom_col(position = "dodge") +
labs(title = "Mean LOS by Gender and Admission Type",
x = "Gender", y = "Average LOS (Days)") +
theme_minimal()



# --- Assumption Checks ------------------------------------------------------



ggplot(dfq, aes(sample = los)) +
stat_qq() + stat_qq_line(color = "blue") +
facet_wrap(~ admission_type) +
theme_minimal() +
labs(title = "QQ Plot of LOS by Admission Type")
# --- final takeway --------------------------------------------------------------


cat("
• Emergency patients stay significantly SHORTER than elective patients.
• Observed mean ratio (Emergency/Elective) ≈ ", round(mean_emergency/mean_elective, 3), ".
• Welch t-test: p-value from t_res = ", signif(t_res$p.value, 3), ".
• Effect size is small-to-moderate (report the actual Cohen's d below).
• Implication: elective (often surgical) cases drive longer LOS; plan capacity accordingly.
")


```


# Results 
- Overview of Analytical Framework To evaluate the four SMART research questions, the team employed a quantitative,
inferential statistics approach using the SPARCS 2012 Hospital Inpatient Discharges dataset (Niagara County subset, 21 075 records × 34 variables).
- Data cleaning steps
included removal of duplicate and clearly erroneous entries, exclusion of outlier values beyond the 99th percentile for continuous variables and grouping of insurance
categories to ensure consistency across comparisons.
- Statistical Methodology Because group variances were unequal and sample sizes were imbalanced, all pairwise comparisons were conducted using Welch’s Two-Sample t-Test, which does not assume
homogeneity of variance. 
- Normality was verified visually and through log-transformation
checks. 
- For the Length of Stay (LOS) variable, an additional Levene’s Test for homogeneity of variance and a robustness check using log (LOS) were performed.
- Finally, an ordinary least-squares (OLS) model was fitted to confirm findings under
multivariable control (Age Group and Gender).


## SMART Question1: Medicare vs Private (LOS)
- Mean LOS = **4.62 days (Medicare)** vs **2.64 days (Private)**.
- *t* ≈ 12.3, *p* < 2.2×10⁻¹⁶ → **Significant**. Reject H₀. Medicare stays are longer.


## SMART Question2: Medicaid vs Private (Costs & Charges)
- Total Costs ≈ 11.88% lower and Total Charges ≈ 6.47% lower for Medicaid.
- *t* = –9.69 and –5.19; *p* < 0.001 for both of them→ **Significant**, but **opposite to hypothesis** (Medicaid lower). → Reject H₁, support H₀. 
- Medicaid total costs and total charges are
lower than Private, opposite to the initial hypothesis.



## SMART Question3: Age 70+ vs 30–49 (LOS)
- Difference ≈ +5%; *p* < 0.05 → **there is a statistically significant difference between the two group means.**
-  Elderly pationts(70+) stay signigicantly longer in the hospital compared to pationts aged 30-49.


## SMART Question4: Elective vs Emergency (LOS)
- Levene *F* = 246.15, *p* < 2.2×10⁻¹⁶ → unequal variances.
- Welch *t* = 12.23, *p* < 2.2×10⁻¹⁶; Mean LOS 6.724 (Elective) vs 5.049 (Emergency); 95% CI [1.406, 1.943]; Cohen’s d ≈ 0.26 (small–moderate).
- Log(LOS) confirmed significance ( LOS test t = 8.20, p &lt; 3×10⁻¹⁶ confirmed significance).
- OLS model (LOS ~ Admission Type + Age + Gender): Emergency Estimate ≈ –1.90 days (*p* < 2×10⁻¹⁶).
→ All analytic layers yielded consistent direction and statistical significance.


# Conclusion & Discussion

Insurance type and admission type are the strongest predictors of hospital stay and cost. Medicare patients stay longer due to higher complexity, while Medicaid patients show lower costs linked to reimbursement policies. Age has minimal effect once clinical factors are considered. Elective admissions last about 1.7 days longer than emergencies. Overall, hospitals should focus on payer type, admission category, and case complexity—not age—for resource planning and policy decisions.

# Project Workflow Summary (structured outline)

1. Data acquisition & initial inspection
2. Data cleaning and variable derivation (document every transformation)
3. Exploratory Data Analysis (visual + summary statistics)
4. Hypothesis specification (SMART questions)
5. Statistical testing / modeling (with assumption checks)
6. Interpretation and robustness checks
7. Reporting: visualizations, tables for each SMART question, and final HTML


# Reference

Dataset Link:
https://health.data.ny.gov/Health/Hospital-Inpatient-Discharges-SPARCS-De-Identified/u4ud-w55t/about_data



<!-- End -->
